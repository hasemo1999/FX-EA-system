# バックテスト最適化の全過程記録

## プロジェクト概要
- **目標**: PF ≥ 1.30、WF合格率 ≥ 70%、MaxDD ≤ 10%
- **期間**: 2023-01-01 から 2024-12-31（24ヶ月）
- **通貨ペア**: USD/JPY
- **データ**: 5分足OHLCV

## ベース設定の確立

### 最適パラメータ（確定）
```json
{
  "vol_ratio_th": 1.5,
  "tp_pts": 2.0,
  "use_atr_tp": false,
  "session_start": "00:00",
  "session_end": "23:59",
  "direction": "long"
}
```

### ベース設定のパフォーマンス
- **取引数**: 159回
- **PF**: 1.186（目標1.30の91%達成）
- **勝率**: 49.1%
- **純利益**: +12.89 pt
- **MaxDD**: -6.49 pt（目標10%以内達成）
- **WF合格率**: 83.33%（目標70%以上達成）
- **AvgR**: 0.081

## 改善機能の実装とテスト結果

### 1. ニュース除外機能

#### 実装内容
- **機能**: CPI、FOMC、NFP発表前後30分を除外
- **対象期間**: 2023-2024年（64回のニュース）
- **除外時間**: 各ニュース前後30分

#### テスト結果
- **取引数**: 159回（変化なし）
- **PF**: 1.186（変化なし）
- **結論**: 効果なし（ニュース時刻と取引シグナルが重複していない）

### 2. ブレークイーブン機能

#### 実装内容
- **機能**: +0.5R到達時にストップを建値に移動
- **設定**: `use_breakeven: true`, `breakeven_r: 0.5`

#### テスト結果
- **取引数**: 159回 → 207回（+30%）
- **PF**: 1.186 → 1.140（-0.046）
- **勝率**: 49.1% → 29.5%（-40%）
- **純利益**: +12.89 → +7.58（-5.31）
- **AvgR**: 0.081 → 0.037（改善）
- **結論**: 勝率を大幅に低下させるため逆効果

### 3. MTF傾きフィルタ

#### 実装内容
- **機能**: 1HのEMA(9/21)の傾きでフィルタリング
- **ロング**: 上向き(差分>0)のみ許可
- **ショート**: 下向き(差分<0)のみ許可

#### テスト結果
- **取引数**: 207回（ブレークイーブンと組み合わせ）
- **PF**: 1.140（変化なし）
- **結論**: 実装に問題があり効果なし

### 4. 時間帯除外機能

#### 初回実装（flat方式）
- **除外時間**: UTC 13:00-15:00（JST 22:00-24:00）
- **方式**: 除外時間帯で強制クローズ

#### 初回テスト結果
- **取引数**: 159回 → 311回（+95%）
- **PF**: 1.186 → 1.043（-0.143）
- **勝率**: 49.1% → 37.6%（-23%）
- **純利益**: +12.89 → +3.58（-9.31）
- **MaxDD**: -6.49 → -10.64（+4.15）
- **問題**: 強制クローズによりチョップ（ぶつ切り）が増加

#### 修正実装（no_entry方式）
- **方式**: 除外時間帯で新規エントリーのみ禁止、既存ポジは持ち越し

#### 修正テスト結果
- **取引数**: 311回 → 180回（-42%）
- **PF**: 1.043 → 1.193（+0.150）
- **勝率**: 37.6% → 47.8%（+27%）
- **純利益**: +3.58 → +15.83（+12.25）
- **WF合格率**: 66.67% → 83.33%（+25%）
- **MaxDD**: -10.64 → -9.64（改善）
- **結論**: 部分的成功（PF改善、MaxDDは目標超過）

## 最終結果比較

| 設定 | 取引数 | PF | 勝率 | 純利益 | MaxDD | WF合格率 | AvgR |
|------|--------|----|------|--------|-------|----------|------|
| **ベース（24h・Static 2.0）** | 159回 | 1.186 | 49.1% | +12.89 | -6.49 | 83.33% | 0.081 |
| **時間帯除外（no_entry）** | 180回 | 1.193 | 47.8% | +15.83 | -9.64 | 83.33% | 0.088 |

## 重要な発見と教訓

### 1. 改善機能の効果
- **ニュース除外**: 効果なし（データ特性）
- **ブレークイーブン**: 逆効果（勝率大幅低下）
- **MTF傾きフィルタ**: 実装問題で効果なし
- **時間帯除外**: 方式により結果が大きく変わる

### 2. 時間帯除外の教訓
- **flat方式**: 強制クローズによりチョップ増加、大幅悪化
- **no_entry方式**: 新規エントリー制限で効果的
- **除外時間**: UTC 13:00-15:00（JST 22:00-24:00）が効果的

### 3. ベース設定の優位性
- **安定性**: すべての改善機能より安定したパフォーマンス
- **リスク管理**: MaxDD -6.49で目標10%以内を達成
- **WF合格率**: 83.33%で目標70%以上を大幅達成

## 次の改善戦略

### 優先度順
1. **ショートポジション検証** (`direction: "both"`)
   - 理由: リスク分散でMaxDD改善の可能性
   - 期待効果: 時間帯除外 + ショートで最適化

2. **時間帯除外の微調整**
   - 除外時間の短縮: 13:00-14:00のみ
   - 期待効果: 効果を維持しつつリスク軽減

3. **複数通貨ペア検証**
   - 対象: EUR/USD, GBP/USD
   - 理由: 戦略の汎用性確認

## 技術的実装詳細

### 実装された機能
1. **ニュース除外機能**: `_load_news_exclusions()`, `_is_news_exclusion_time()`
2. **ブレークイーブン機能**: ポジション管理ループ内で実装
3. **MTF傾きフィルタ**: `_higher_tf_slope_filter()`
4. **時間帯除外機能**: `_time_session_mask()`, セッションポリシー

### 設定ファイル
- `backtest_config_best_24h.json`: ベース設定
- `backtest_config_pf_improved.json`: PF改善用
- `backtest_config_time_exclude_fixed.json`: 時間帯除外（no_entry）

### コード修正履歴
- セッションポリシー機能追加
- 強制クローズ条件の修正
- 時間帯除外マスクの実装
- ニュース除外機能の実装

## 現在の最適設定

### 選択肢1: 時間帯除外を採用
```json
{
  "time_sessions": [
    {"start": "00:00", "end": "12:59"},
    {"start": "15:01", "end": "23:59"}
  ],
  "session_policy": "no_entry"
}
```
- **メリット**: PF 1.193、純利益 +15.83
- **デメリット**: MaxDD -9.64（リスク増加）

### 選択肢2: ベース設定を維持
- **メリット**: MaxDD -6.49（リスク低）
- **デメリット**: PF 1.186（目標未達）

## 結論
時間帯除外（no_entry方式）が最も効果的な改善機能であることが確認された。ただし、MaxDDの増加が課題であり、ショートポジションの追加によるリスク分散が次の最適化の鍵となる。
